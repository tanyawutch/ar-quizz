<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Admin Master - Analysis Mode</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.4.0/model-viewer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --p: #0288d1; --s: #2e7d32; --bg: #f8fafc; --edit: #ff9800; --copy: #673ab7; --export: #607d8b; }
        body { font-family: 'Sarabun', sans-serif; background: var(--bg); padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .card { background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .quiz-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: #fff; margin-bottom: 10px; border-radius: 10px; }
        .btn { padding: 10px 18px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; font-family: 'Sarabun'; transition: 0.2s; font-size: 14px; }
        .btn-blue { background: var(--p); color: white; }
        .btn-green { background: var(--s); color: white; width: 100%; font-size: 1.1rem; }
        .btn-edit { background: var(--edit); color: white; margin-right: 5px; }
        .btn-copy { background: var(--copy); color: white; margin-right: 5px; }
        .btn-export { background: var(--export); color: white; margin-right: 5px; }
        .btn-del { background: #ef5350; color: white; }
        .preview-box { background: #000; height: 250px; border-radius: 10px; margin-top: 10px; }
        input, textarea { width: 100%; padding: 12px; margin-top: 8px; border-radius: 10px; border: 1px solid #cbd5e1; box-sizing: border-box; }
        .badge { background: #e0f2f1; color: #00695c; padding: 4px 10px; border-radius: 5px; font-size: 13px; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="color: var(--p); text-align: center;">‚öôÔ∏è ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö AR</h1>

    <div class="card" id="editor-section">
        <h3 id="editor-title" style="color:var(--p); margin-top:0;">‚ûï ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏´‡∏°‡πà</h3>
        <div id="setup-inputs">
            <div style="display: flex; gap: 10px;">
                <input type="text" id="proj-name" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏∏‡∏î‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö">
                <input type="number" id="q-count" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Ç‡πâ‡∏≠" min="1" style="width:120px;">
                <button class="btn btn-blue" id="init-btn" onclick="initQuiz()">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
            </div>
        </div>
        <div id="quiz-area"></div>
        <div id="action-buttons" style="display:none; margin-top:20px; gap:10px;">
            <button class="btn btn-green" id="save-btn" onclick="saveData()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á</button>
            <button class="btn btn-del" onclick="cancelEdit()" style="width:120px;">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
        </div>
    </div>

    <div id="dashboard-section">
        <div class="card">
            <h3 style="color:var(--s); margin-top:0;">üìÇ ‡∏Ñ‡∏•‡∏±‡∏á‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h3>
            <div id="quiz-list-admin">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
        </div>
    </div>
</div>

<script>
    // üö© Firebase Config ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π
    const firebaseConfig = {
        apiKey: "AIzaSyDBvaBLaqywJ-J3J6hH_UwyF-WmultPim4",
        authDomain: "ar-quizz.firebaseapp.com",
        projectId: "ar-quizz",
        databaseURL: "https://ar-quizz-default-rtdb.asia-southeast1.firebasedatabase.app",
        storageBucket: "ar-quizz.firebasestorage.app",
        messagingSenderId: "151328581741",
        appId: "1:151328581741:web:d148eaa15b7a24b0dcf764"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    let currentEditId = null;

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏°‡∏≤‡πÇ‡∏ä‡∏ß‡πå (‡∏´‡∏±‡∏ß‡πÉ‡∏à‡∏Ç‡∏≠‡∏á‡∏´‡∏ô‡πâ‡∏≤ Admin) ---
    function loadDashboard() {
        console.log("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase..."); // ‡πÄ‡∏ä‡πá‡∏Ñ‡πÉ‡∏ô Console
        db.ref('quizzes').on('value', (snapshot) => {
            const data = snapshot.val();
            const listArea = document.getElementById('quiz-list-admin');
            
            if (!data) { 
                listArea.innerHTML = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏™‡∏≠‡∏ö‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á ‡πÇ‡∏õ‡∏£‡∏î‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö'; 
                return; 
            }

            listArea.innerHTML = ''; 
            for (let id in data) {
                listArea.innerHTML += `
                    <div class="quiz-item">
                        <div>
                            <strong>${data[id].name || '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ä‡∏∑‡πà‡∏≠'}</strong> 
                            <span class="badge">${data[id].questions ? data[id].questions.length : 0} ‡∏Ç‡πâ‡∏≠</span><br>
                            <small style="color:gray;">ID: ${id}</small>
                        </div>
                        <div class="action-group" style="display:flex;">
                            <button class="btn btn-copy" onclick="copyId('${id}')">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å ID</button>
                            <button class="btn btn-edit" onclick="editQuiz('${id}')">üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                            <button class="btn btn-export" onclick="exportData('${id}')">üìä Export</button>
                            <button class="btn btn-del" onclick="deleteQuiz('${id}')">üóëÔ∏è ‡∏•‡∏ö</button>
                        </div>
                    </div>`;
            }
        });
    }

    // --- ‡∏£‡∏∞‡∏ö‡∏ö Export ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏§‡∏ï‡∏¥‡∏Å‡∏£‡∏£‡∏° ---
    window.exportData = function(quizId) {
        db.ref('student_logs').orderByChild('quizId').equalTo(quizId).once('value', (snapshot) => {
            const logs = snapshot.val();
            if (!logs) return alert("‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏≤‡∏°‡∏≤‡∏Ñ‡∏£‡∏±‡∏ö");

            let csv = "\uFEFFStudentName,Q_Number,TimeSpent(s),Interactions,AR_Used,IsCorrect,Confidence,Timestamp\n";
            for (let id in logs) {
                const r = logs[id];
                csv += `${r.name},${r.qIdx+1},${r.time},${r.moves},${r.ar},${r.correct},${r.confidence},${r.timestamp}\n`;
            }
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `Student_Behavior_${quizId}.csv`;
            link.click();
        });
    }

    // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÜ ---
    window.copyId = (id) => { navigator.clipboard.writeText(id); alert("‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡πÅ‡∏•‡πâ‡∏ß!"); }
    window.deleteQuiz = (id) => { if(confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?')) db.ref('quizzes/' + id).remove(); }
    
    window.initQuiz = function(existing = null) {
        const n = existing ? existing.length : parseInt(document.getElementById('q-count').value);
        const area = document.getElementById('quiz-area');
        area.innerHTML = '';
        for(let i=0; i<n; i++) {
            const d = existing ? existing[i] : {q:'', o:[], a:'', m:''};
            area.innerHTML += `
                <div style="border:1px solid #eee; padding:20px; border-radius:12px; margin-top:15px; background:#fafafa;">
                    <h4>‡∏Ç‡πâ‡∏≠‡∏ó‡∏µ‡πà ${i+1}</h4>
                    <textarea id="q-${i}" placeholder="‡πÇ‡∏à‡∏ó‡∏¢‡πå">${d.q}</textarea>
                    <input type="text" id="o-${i}" placeholder="‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏Å,‡∏Ç,‡∏Ñ,‡∏á)" value="${d.o.join(',')}">
                    <input type="text" id="a-${i}" placeholder="‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö" value="${d.a}">
                    <input type="text" id="m-${i}" placeholder="‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÇ‡∏°‡πÄ‡∏î‡∏• .glb" value="${d.m}" oninput="document.getElementById('v-${i}').src=this.value">
                    <div class="preview-box"><model-viewer id="v-${i}" src="${d.m}" camera-controls ar style="width:100%; height:100%;"></model-viewer></div>
                </div>`;
        }
        document.getElementById('action-buttons').style.display = 'flex';
    }

    window.saveData = async function() {
        const name = document.getElementById('proj-name').value;
        const n = parseInt(document.getElementById('q-count').value);
        const qs = [];
        for(let i=0; i<n; i++) {
            qs.push({
                q: document.getElementById(`q-${i}`).value,
                o: document.getElementById(`o-${i}`).value.split(','),
                a: document.getElementById(`a-${i}`).value,
                m: document.getElementById(`m-${i}`).value
            });
        }
        if (currentEditId) await db.ref('quizzes/' + currentEditId).set({ name, questions: qs });
        else await db.ref('quizzes').push({ name, questions: qs });
        alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!");
        location.reload();
    }

    window.editQuiz = function(id) {
        db.ref('quizzes/' + id).once('value', (s) => {
            const data = s.val();
            currentEditId = id;
            document.getElementById('editor-title').innerText = "üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: " + data.name;
            document.getElementById('proj-name').value = data.name;
            document.getElementById('q-count').value = data.questions.length;
            initQuiz(data.questions);
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
    }

    window.cancelEdit = () => { location.reload(); }

    // ‡∏£‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤
    loadDashboard();
</script>
</body>
</html>
